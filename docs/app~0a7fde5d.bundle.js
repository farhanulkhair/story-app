"use strict";(self.webpackChunkstory_app=self.webpackChunkstory_app||[]).push([[866],{703:(t,e,r)=>{r.d(e,{A:()=>v});var n=r(255),a=r(84),o=r(105);function i(t){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i(t)}function s(){s=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},o=a.iterator||"@@iterator",u=a.asyncIterator||"@@asyncIterator",c=a.toStringTag||"@@toStringTag";function p(t,e,r,n){return Object.defineProperty(t,e,{value:r,enumerable:!n,configurable:!n,writable:!n})}try{p({},"")}catch(t){p=function(t,e,r){return t[e]=r}}function f(e,r,n,a){var o=r&&r.prototype instanceof d?r:d,i=Object.create(o.prototype);return p(i,"_invoke",function(e,r,n){var a=1;return function(o,i){if(3===a)throw Error("Generator is already running");if(4===a){if("throw"===o)throw i;return{value:t,done:!0}}for(n.method=o,n.arg=i;;){var s=n.delegate;if(s){var u=S(s,n);if(u){if(u===l)continue;return u}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(1===a)throw a=4,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);a=3;var c=h(e,r,n);if("normal"===c.type){if(a=n.done?4:2,c.arg===l)continue;return{value:c.arg,done:n.done}}"throw"===c.type&&(a=4,n.method="throw",n.arg=c.arg)}}}(e,n,new _(a||[])),!0),i}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=f;var l={};function d(){}function v(){}function b(){}var y={};p(y,o,(function(){return this}));var g=Object.getPrototypeOf,m=g&&g(g(O([])));m&&m!==r&&n.call(m,o)&&(y=m);var w=b.prototype=d.prototype=Object.create(y);function x(t){["next","throw","return"].forEach((function(e){p(t,e,(function(t){return this._invoke(e,t)}))}))}function k(t,e){function r(a,o,s,u){var c=h(t[a],t,o);if("throw"!==c.type){var p=c.arg,f=p.value;return f&&"object"==i(f)&&n.call(f,"__await")?e.resolve(f.__await).then((function(t){r("next",t,s,u)}),(function(t){r("throw",t,s,u)})):e.resolve(f).then((function(t){p.value=t,s(p)}),(function(t){return r("throw",t,s,u)}))}u(c.arg)}var a;p(this,"_invoke",(function(t,n){function o(){return new e((function(e,a){r(t,n,e,a)}))}return a=a?a.then(o,o):o()}),!0)}function S(e,r){var n=r.method,a=e.i[n];if(a===t)return r.delegate=null,"throw"===n&&e.i.return&&(r.method="return",r.arg=t,S(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),l;var o=h(a,e.i,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,l;var i=o.arg;return i?i.done?(r[e.r]=i.value,r.next=e.n,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,l):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,l)}function E(t){this.tryEntries.push(t)}function A(e){var r=e[4]||{};r.type="normal",r.arg=t,e[4]=r}function _(t){this.tryEntries=[[-1]],t.forEach(E,this),this.reset(!0)}function O(e){if(null!=e){var r=e[o];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var a=-1,s=function r(){for(;++a<e.length;)if(n.call(e,a))return r.value=e[a],r.done=!1,r;return r.value=t,r.done=!0,r};return s.next=s}}throw new TypeError(i(e)+" is not iterable")}return v.prototype=b,p(w,"constructor",b),p(b,"constructor",v),v.displayName=p(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===v||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,p(t,c,"GeneratorFunction")),t.prototype=Object.create(w),t},e.awrap=function(t){return{__await:t}},x(k.prototype),p(k.prototype,u,(function(){return this})),e.AsyncIterator=k,e.async=function(t,r,n,a,o){void 0===o&&(o=Promise);var i=new k(f(t,r,n,a),o);return e.isGeneratorFunction(r)?i:i.next().then((function(t){return t.done?t.value:i.next()}))},x(w),p(w,c,"Generator"),p(w,o,(function(){return this})),p(w,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.unshift(n);return function t(){for(;r.length;)if((n=r.pop())in e)return t.value=n,t.done=!1,t;return t.done=!0,t}},e.values=O,_.prototype={constructor:_,reset:function(e){if(this.prev=this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(A),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0][4];if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function n(t){i.type="throw",i.arg=e,r.next=t}for(var a=r.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o[4],s=this.prev,u=o[1],c=o[2];if(-1===o[0])return n("end"),!1;if(!u&&!c)throw Error("try statement without catch or finally");if(null!=o[0]&&o[0]<=s){if(s<u)return this.method="next",this.arg=t,n(u),!0;if(s<c)return n(c),!1}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n[0]>-1&&n[0]<=this.prev&&this.prev<n[2]){var a=n;break}}a&&("break"===t||"continue"===t)&&a[0]<=e&&e<=a[2]&&(a=null);var o=a?a[4]:{};return o.type=t,o.arg=e,a?(this.method="next",this.next=a[2],l):this.complete(o)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),l},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r[2]===t)return this.complete(r[4],r[3]),A(r),l}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r[0]===t){var n=r[4];if("throw"===n.type){var a=n.arg;A(r)}return a}}throw Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={i:O(e),r,n},"next"===this.method&&(this.arg=t),l}},e}function u(t,e,r,n,a,o,i){try{var s=t[o](i),u=s.value}catch(t){return void r(t)}s.done?e(u):Promise.resolve(u).then(n,a)}function c(t){return function(){var e=this,r=arguments;return new Promise((function(n,a){var o=t.apply(e,r);function i(t){u(o,n,a,i,s,"next",t)}function s(t){u(o,n,a,i,s,"throw",t)}i(void 0)}))}}function p(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,f(n.key),n)}}function f(t){var e=function(t,e){if("object"!=i(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,e||"default");if("object"!=i(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==i(e)?e:e+""}function h(t,e){(function(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")})(t,e),e.add(t)}var l=new WeakSet;var d=function(){function t(){if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),h(this,l),t.instance)return t.instance;this.baseUrl=n.A.BASE_URL,t.instance=this}return e=t,r=[{key:"getAllStories",value:(E=c(s().mark((function t(){var e,r,n,i,u;return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,e=a.A.getToken()){t.next=4;break}return t.abrupt("return",{error:!0,message:"Not authenticated"});case 4:return t.next=7,fetch("".concat(this.baseUrl,"/stories"),{headers:{Authorization:"Bearer ".concat(e)}});case 7:return r=t.sent,t.next=10,r.json();case 10:if(!(n=t.sent).error){t.next=14;break}return t.abrupt("return",{error:!0,message:n.message});case 14:if(!((i=n.listStory||[]).length>0)){t.next=20;break}return t.next=19,o.A.putBulkStories(i);case 19:case 20:return t.abrupt("return",{error:!1,data:{stories:i}});case 23:return t.prev=23,t.t0=t.catch(0),t.prev=26,t.next=29,o.A.getAllStories();case 29:if(!((u=t.sent).length>0)){t.next=33;break}return t.abrupt("return",{error:!1,message:"Stories retrieved from local database",data:{stories:u}});case 33:t.next=38;break;case 35:t.prev=35,t.t1=t.catch(26);case 38:return t.abrupt("return",{error:!0,message:"Failed to fetch stories"});case 39:case"end":return t.stop()}}),t,this,[[0,23],[26,35]])}))),function(){return E.apply(this,arguments)})},{key:"getStoryDetail",value:(S=c(s().mark((function t(e){var r,n,i,u;return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=4,o.A.getStory(e);case 4:if(!(r=t.sent)){t.next=8;break}return t.abrupt("return",{error:!1,message:"Story retrieved from local database",data:{story:r}});case 8:if(n=a.A.getToken()){t.next=13;break}return t.abrupt("return",{error:!0,message:"Not authenticated"});case 13:return t.next=15,fetch("".concat(this.baseUrl,"/stories/").concat(e),{headers:{Authorization:"Bearer ".concat(n)}});case 15:return i=t.sent,t.next=18,i.json();case 18:if(!(u=t.sent).error){t.next=23;break}return t.abrupt("return",u);case 23:if(!u.story){t.next=27;break}return t.next=26,o.A.putStory(u.story);case 26:case 27:return t.abrupt("return",{error:!1,data:{story:u.story}});case 30:return t.prev=30,t.t0=t.catch(0),t.abrupt("return",{error:!0,message:"Failed to fetch story detail"});case 34:case"end":return t.stop()}}),t,this,[[0,30]])}))),function(t){return S.apply(this,arguments)})},{key:"addNewStory",value:(k=c(s().mark((function t(e){var r,n,i,u,c,p,f,h,l,d,v,b,y,g,m,w;return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=e.description,n=e.photo,i=e.lat,u=e.lon,t.prev=1,r&&n){t.next=5;break}return t.abrupt("return",{error:!0,message:"Description and photo are required"});case 5:return t.next=8,this._optimizePhoto(n);case 8:if(d=t.sent,(v=new FormData).append("description",r),v.append("photo",d),null!==i&&null!==u&&(v.append("lat",i.toString()),v.append("lon",u.toString())),b=a.A.getToken()){t.next=17;break}return t.abrupt("return",{error:!0,message:"Not authenticated"});case 17:return t.next=19,fetch("".concat(this.baseUrl,"/stories"),{method:"POST",headers:{Authorization:"Bearer ".concat(b)},body:v});case 19:return y=t.sent,t.next=22,y.json();case 22:if(!(g=t.sent).error){t.next=26;break}return t.abrupt("return",{error:!0,message:g.message});case 26:if(m={id:(null===(c=g.story)||void 0===c?void 0:c.id)||Date.now().toString(),name:(null===(p=g.story)||void 0===p?void 0:p.name)||"Anonymous",description:r,photoUrl:null===(f=g.story)||void 0===f?void 0:f.photoUrl,createdAt:(null===(h=g.story)||void 0===h?void 0:h.createdAt)||(new Date).toISOString(),lat:i||null,lon:u||null,userId:null===(l=g.story)||void 0===l?void 0:l.userId},g.error){t.next=40;break}return t.next=32,o.A.putStory(m);case 32:return t.next=34,this.getAllStories();case 34:if((w=t.sent).error){t.next=39;break}return t.next=38,o.A.putBulkStories(w.data.stories);case 38:case 39:return t.abrupt("return",{error:!1,data:{story:m}});case 40:t.next=46;break;case 42:return t.prev=42,t.t0=t.catch(1),t.abrupt("return",{error:!0,message:t.t0.message||"Failed to add story"});case 46:case"end":return t.stop()}}),t,this,[[1,42]])}))),function(t){return k.apply(this,arguments)})},{key:"_optimizePhoto",value:(x=c(s().mark((function t(e){var r,n,a,o,i,u;return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,!(e.size<=1048576)){t.next=3;break}return t.abrupt("return",e);case 3:return r=document.createElement("img"),n=URL.createObjectURL(e),t.next=7,new Promise((function(t){r.onload=t,r.src=n}));case 7:return a=document.createElement("canvas"),o=r.width,i=r.height,u=1280,o>i&&o>u?(i=i*u/o,o=u):i>u&&(o=o*u/i,i=u),a.width=o,a.height=i,a.getContext("2d").drawImage(r,0,0,o,i),URL.revokeObjectURL(n),t.abrupt("return",new Promise((function(t){a.toBlob((function(e){return t(e)}),"image/jpeg",.7)})));case 20:return t.prev=20,t.t0=t.catch(0),t.abrupt("return",e);case 24:case"end":return t.stop()}}),t,null,[[0,20]])}))),function(t){return x.apply(this,arguments)})},{key:"_saveToIndexedDB",value:(w=c(s().mark((function t(e){var r,a,o;return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,openDB(n.A.DATABASE_NAME,n.A.DATABASE_VERSION);case 3:return r=t.sent,a=r.transaction(n.A.OBJECT_STORE_NAME,"readwrite"),o=a.objectStore(n.A.OBJECT_STORE_NAME),t.next=8,o.put(e);case 8:return t.next=10,a.done;case 10:t.next=15;break;case 12:t.prev=12,t.t0=t.catch(0);case 15:case"end":return t.stop()}}),t,null,[[0,12]])}))),function(t){return w.apply(this,arguments)})},{key:"notifySubscription",value:(m=c(s().mark((function t(){var e,r;return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,navigator.serviceWorker.ready;case 3:(e=t.sent).pushManager&&(r={title:"Notifikasi Diaktifkan",options:{body:"Anda akan menerima notifikasi untuk setiap story baru yang dibuat",icon:"/icons/icon-72x72.png",badge:"/icons/icon-72x72.png"}},e.active.postMessage({type:"PUSH_NOTIFICATION",data:r})),t.next=10;break;case 7:t.prev=7,t.t0=t.catch(0);case 10:case"end":return t.stop()}}),t,null,[[0,7]])}))),function(){return m.apply(this,arguments)})},{key:"notifyUnsubscription",value:(g=c(s().mark((function t(){var e,r;return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,navigator.serviceWorker.ready;case 3:(e=t.sent).pushManager&&(r={title:"Notifikasi Dinonaktifkan",options:{body:"Anda tidak akan menerima notifikasi lagi untuk story baru",icon:"/icons/icon-72x72.png",badge:"/icons/icon-72x72.png"}},e.active.postMessage({type:"PUSH_NOTIFICATION",data:r})),t.next=10;break;case 7:t.prev=7,t.t0=t.catch(0);case 10:case"end":return t.stop()}}),t,null,[[0,7]])}))),function(){return g.apply(this,arguments)})},{key:"_sendPushNotification",value:(y=c(s().mark((function t(e){var r,n;return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,navigator.serviceWorker.ready;case 3:if((r=t.sent).pushManager){t.next=8;break}return t.abrupt("return");case 8:return t.next=10,r.pushManager.getSubscription();case 10:if(t.sent){t.next=14;break}return t.abrupt("return");case 14:n={title:"Story App Notification",options:{body:"Story baru saja ditambahkan",icon:"/favicon.png",badge:"/favicon.png",vibrate:[100,50,100],data:{dateOfArrival:Date.now(),url:window.location.origin+"/#/home"}}},r.active.postMessage({type:"PUSH_NOTIFICATION",data:n}),t.next=24;break;case 21:t.prev=21,t.t0=t.catch(0);case 24:case"end":return t.stop()}}),t,null,[[0,21]])}))),function(t){return y.apply(this,arguments)})},{key:"deleteStory",value:(b=c(s().mark((function t(e){var r,n;return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,fetch("".concat(this.baseUrl,"/stories/").concat(e),{method:"DELETE"});case 3:return r=t.sent,t.next=6,r.json();case 6:if((n=t.sent).error){t.next=10;break}return t.next=10,o.A.deleteStory(e);case 10:return t.abrupt("return",n);case 13:return t.prev=13,t.t0=t.catch(0),t.abrupt("return",{error:!0,message:"Failed to delete story"});case 17:case"end":return t.stop()}}),t,this,[[0,13]])}))),function(t){return b.apply(this,arguments)})},{key:"searchStories",value:(v=c(s().mark((function t(e){return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,o.A.searchStories(e);case 3:return t.abrupt("return",t.sent);case 6:return t.prev=6,t.t0=t.catch(0),t.abrupt("return",[]);case 10:case"end":return t.stop()}}),t,null,[[0,6]])}))),function(t){return v.apply(this,arguments)})},{key:"subscribePushNotification",value:(d=c(s().mark((function t(e){var r,o,i,u;return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,e&&e.endpoint){t.next=3;break}throw new Error("Invalid subscription object");case 3:if(r=e.toJSON(),o=a.A.getToken()){t.next=9;break}throw new Error("Not authenticated");case 9:return t.next=11,fetch("".concat(this.baseUrl).concat(n.A.PUSH_MSG_SUBSCRIBE_URL),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(o)},body:JSON.stringify({endpoint:e.endpoint,keys:{p256dh:r.keys.p256dh,auth:r.keys.auth}})});case 11:return i=t.sent,t.next=14,i.json();case 14:if((u=t.sent).error){t.next=24;break}return t.next=20,this.notifySubscription();case 20:return localStorage.setItem("notificationSubscribed","true"),t.abrupt("return",u);case 24:throw new Error(u.message||"Server subscription failed");case 26:t.next=32;break;case 28:return t.prev=28,t.t0=t.catch(0),t.abrupt("return",{error:!0,message:t.t0.message||"Failed to subscribe to push notifications"});case 32:case"end":return t.stop()}}),t,this,[[0,28]])}))),function(t){return d.apply(this,arguments)})},{key:"unsubscribePushNotification",value:(f=c(s().mark((function t(e){var r,o,i;return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,e&&e.endpoint){t.next=3;break}throw new Error("Invalid subscription object");case 3:if(r=a.A.getToken()){t.next=7;break}throw new Error("Not authenticated");case 7:return t.next=9,fetch("".concat(this.baseUrl).concat(n.A.PUSH_MSG_UNSUBSCRIBE_URL),{method:"DELETE",headers:{Authorization:"Bearer ".concat(r),"Content-Type":"application/json"},body:JSON.stringify({endpoint:e.endpoint})});case 9:return o=t.sent,t.next=12,o.json();case 12:if((i=t.sent).error){t.next=21;break}return t.next=18,this.notifyUnsubscription();case 18:localStorage.removeItem("notificationSubscribed"),t.next=23;break;case 21:throw new Error(i.message||"Server unsubscription failed");case 23:return t.abrupt("return",i);case 26:return t.prev=26,t.t0=t.catch(0),t.abrupt("return",{error:!0,message:t.t0.message||"Failed to unsubscribe from push notifications"});case 30:case"end":return t.stop()}}),t,this,[[0,26]])}))),function(t){return f.apply(this,arguments)})},{key:"isSubscribed",value:(u=c(s().mark((function t(){var e;return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,navigator.serviceWorker.ready;case 3:if((e=t.sent).pushManager){t.next=6;break}return t.abrupt("return",!1);case 6:return t.next=8,e.pushManager.getSubscription();case 8:if(t.sent){t.next=12;break}return localStorage.removeItem("notificationSubscribed"),t.abrupt("return",!1);case 12:return localStorage.getItem("notificationSubscribed")||localStorage.setItem("notificationSubscribed","true"),t.abrupt("return",!0);case 16:return t.prev=16,t.t0=t.catch(0),t.abrupt("return",!1);case 20:case"end":return t.stop()}}),t,null,[[0,16]])}))),function(){return u.apply(this,arguments)})}],i=[{key:"getInstance",value:function(){return t.instance||(t.instance=new t),t.instance}}],r&&p(e.prototype,r),i&&p(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,r,i,u,f,d,v,b,y,g,m,w,x,k,S,E}().getInstance();Object.freeze(d);const v=d}}]);
//# sourceMappingURL=app~0a7fde5d.bundle.js.map